name: Remove feature branch deployment

on:
  pull_request:
    types: [ unlabeled, closed ]

jobs:
  only-on-deployment-branches:
    name: Only on deployment branches
    if: ${{ (github.event.action == 'closed' && contains(github.event.pull_request.labels.*.name, 'deploy!')) || ((github.event.action == 'unlabeled') && (github.event.label.name = 'deploy!')) }}
    runs-on: ubuntu-latest
    outputs:
      deployment-name: ${{ steps.extract.outputs.deployment-name }}
    steps:
      - id: extract
        env:
          PR_NUMBER: ${{ (github.event.pull_request && github.event.pull_request.number) || '' }}
        run: |
          if [ "$PR_NUMBER" = "" ]; then
            echo "::set-output name=deployment-name::dev"
          else
            echo "::set-output name=deployment-name::pr-$PR_NUMBER"
          fi

      - env:
          EXTRACTED: ${{ steps.extract.outputs.deployment-name }}
        run: 'echo "Deployment name: $EXTRACTED"'

  # TODO actually uninstall the feature branch deployment, using `helm delete xyz`